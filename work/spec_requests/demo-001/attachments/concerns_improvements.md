# Spec Workflow: Concerns & Improvements (demo-001)

This document collects issues and suggestions observed while exercising the spec change workflow.

## Concerns

- Attachment path safety: `spec.msg.push` joins `src_root` with message-provided relative paths. A crafted `../` sequence could escape the request root if the JSON is tampered with. Suggest validating `Path.expand(src)` stays within `src_root` before copying.
- Weak type validation: `spec.msg.new` accepts any `--type` string. Without validation, downstream tooling may assume a small enum (comment|question|proposal|decision) and behave unpredictably.
- Lint depth: `spec.lint` checks JSON shape superficially but does not validate against the provided `work/spec_requests/message.schema.json` and `ack.schema.json`.
- Ordering of thread: Ensure `spec.thread.render` sorts messages deterministically (e.g., by `created_at`, then `id`) across inbox/outbox to avoid flicker in reviews.
- Cross-repo collisions: If different requests attach files with identical names (e.g., `design.png`), ensure targets are namespaced under `attachments/` and include the message id to avoid overwrites on the receiver side.
- Large files: No size checks for attachments; accidental large binaries could bloat repos/PRs. Consider a size limit and CI guard.

## Improvements

- Add `--dry-run` to `spec.msg.push`/`spec.msg.pull` to print planned copies without side effects.
- Add `--only` filters to push/pull (e.g., `--only msg_20250831*` or `--since 2025-08-31T00:00Z`).
- JSON Schema validation in `spec.lint` using a library; report precise paths for failures.
- Attachment de-duplication: store under `attachments/<sha256>/<filename>` to avoid duplicates.
- Message provenance: optional signing or HMAC for messages to increase trust across repos.
- Better env ergonomics: `.env.example` for `SPEC_HANDOFF_DIR`, and Mix tasks read it automatically.
- Rollout safety: `spec.rollout` could print a preflight summary (targets found/absent, disk space check, dry-run) and support `--continue-on-error`.
- Hub sync locking: create a lockfile to avoid concurrent `spec.hub.sync` runs stepping on each other.

## Changes Proposed

1) Harden attachment copy with path normalization and root containment check.
2) Validate message/ack with JSON Schema; fail CI if violations are committed.
3) Implement `--dry-run` and filtering flags for push/pull.
4) Deterministic message ordering in `thread.md` and include per-message anchors.
5) Optional dedup and size limits for attachments; CI guard with a threshold.

â€” demo-001 feedback, generated by tooling

